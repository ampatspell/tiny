<%
  let backgrounds = {
    'transparent': 0,
    'black': 1,
    'white': 2
  };

  let layerClasses = {
    'grid': 'GridLayer',
    'pixel': 'PixelLayer'
  };

  let nodeClasses = {
    'sprite/loop': 'SpriteLoopNode',
    'sprite/frame': 'SpriteFrameNode',
  };

  scene.className = 'Scene';
  scene.namespace = `Scene_${scene.index}`;
  scene.backgroundType = backgrounds[scene.background];
  scene.sizeof = [];
  scene.layers.forEach((layer, lidx) => {
    layer.className = layerClasses[layer.type];
    layer.variable = `layer_${lidx}`;
    layer.nodes.forEach((node, nidx) => {
      node.variable = `${layer.variable}_node_${nidx}`;
      node.className = nodeClasses[node.type];
    });
  });

  scene.nodes = scene.layers.reduce((arr, layer) => {
    layer.nodes.reduce((arr, node) => {
      arr.push(node);
      return arr;
    }, arr);
    return arr;
  }, []);
-%>

  // Scene:  <%= scene.identifier %>
  namespace <%= scene.namespace %> {

    const uint8_t scene[] PROGMEM = {
      <%= scene.size.width %>, // width
      <%= scene.size.height %>, // height
      <%= scene.backgroundType %> // background: <%= scene.background %>
    };
    <% scene.sizeof.push(`sizeof(${scene.className})`); -%>
    <% scene.sizeof.push(`(sizeof(Layer *) * ${scene.layers.length})`); -%>
<% scene.layers.forEach(layer => { %>
    const uint8_t <%= layer.variable %>[] PROGMEM = {
    <% if (layer.type === 'grid') { %>
      <%= layer.grid.width %>, // grid width
      <%= layer.grid.height %>, // grid height
    <% } else if (layer.type === 'pixel') { %>
    <% } %>
    };
    <% scene.sizeof.push(`sizeof(${layer.className})`); -%>
    <% scene.sizeof.push(`(sizeof(Node *) * ${layer.nodes.length})`); -%>
  <% layer.nodes.forEach(node => { %>
    const uint8_t <%= node.variable %>[] PROGMEM = {
      <%= node.position.x %>, // x
      <%= node.position.y %>, // y
  <% if (node.type.startsWith('sprite/')) { %>
      <%= node.sprite.index -%>, // sprite
    <% if (node.type === 'sprite/frame') { %>
      <%= node.frame.index -%> // frame
    <% } else if (node.type === 'sprite/loop') { %>
      <%= node.loop.index -%> // loop
    <% } %>
  <% } %>
    };

    const size_t <%= node.variable %>_size = sizeof(<%= node.className %>);
    <% scene.sizeof.push(`sizeof(${node.className})`); -%>
  <% }); -%>
<% }); %>

    const size_t scene_size = <%= scene.sizeof.join(' + ') %>;

  }
