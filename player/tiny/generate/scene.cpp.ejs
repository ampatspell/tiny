// Project: <%= project.title %>
// World: <%= world.name %>
// Scene:  <%= scene.identifier -%>

#include <avr/pgmspace.h>
#include <stdint.h>

<% let backgrounds = {
  'transparent': 0,
  'black': 1,
  'white': 2
} -%>
<% let layers = {
  'grid': 'Grid',
  'pixel': 'Pixel'
} -%>
<% scene.variable = `scene_${scene.index}` -%>

namespace Tiny {
  namespace Generated {
    namespace Scenes {

      const uint8_t <% scene.variable %>_definition[] PROGMEM = {

        <%= backgrounds[scene.background] %>, // background: <%= scene.background %>
        <%= scene.size.width %>, // width
        <%= scene.size.height %> // height

      };

      // Layers

    <% scene.layers.forEach((layer, idx) => { %>
      const uint8_t <%= scene.variable %>_layer_<%= idx %>_definition[] PROGMEM = {
    <% if(layer.type === 'grid') { %>
        0, // grid
        <%= layer.grid.width %>, // width
        <%= layer.grid.height %> // height
    <% } else if(layer.type === 'pixel') { %>
        1 // pixel
    <% } %>
      };

    <% }); %>

      // Nodes

    <% scene.layers.forEach((layer, lidx) => { %>
      <% layer.variable = `${scene.variable}_layer_${lidx}` %>
      <% layer.nodes.forEach((node, nidx) => { %>
      <% node.variable = `${layer.variable}_node_${nidx}` %>
      // Node: <%= layer.identifier || lidx %> â†’ <%= node.identifier || nidx %>
      const uint8_t <%= node.variable %>_definition[] PROGMEM = {
      <% if(node.type === 'sprite/frame') { %>
        0, // type: <%= node.type %>
        <%= node.position.x %>, // position.x
        <%= node.position.y %>, // position.y
        <%= node.sprite.model.sprites.indexOf(node.sprite) %>, // sprite index
        <%= node.sprite.frames.indexOf(node.frame) %> // frame index
      <% } else if(node.type === 'sprite/loop') { %>
        1, // type: <%= node.type %>
        <%= node.position.x %>, // position.x
        <%= node.position.y %>, // position.y
        <%= node.sprite.model.sprites.indexOf(node.sprite) %>, // sprite index
        <%= node.sprite.loops.indexOf(node.loop) %> // loop index
      <% } %>
      };
      <% }); %>
      const uint8_t <%= layer.variable %>_node_definitions[] PROGMEM = { <%= layer.nodes.map(node => `${node.variable}_definition`).join(', ') %> };
    <% }); %>
      const uint8_t <%= scene.variable %>_layer_definitions[] PROGMEM = { <%= scene.layers.map(layer => `${layer.variable}_definition`).join(', ') %> };
      const uint8_t <%= scene.variable %>_layer_node_definitions[] PROGMEM = { <%= scene.layers.map(layer => `${layer.variable}_node_definitions`).join(', ') %> };

    }
  }
}
