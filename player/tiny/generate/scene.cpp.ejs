// Scene:  <%= scene.identifier %>

<%

  let backgrounds = {
    'transparent': 0,
    'black': 1,
    'white': 2
  };

  let layerClasses = {
    'grid': 'GridLayer',
    'pixel': 'PixelLayer'
  };

  let nodeClasses = {
    'sprite/loop': 'SpriteLoopNode',
    'sprite/frame': 'SpriteFrameNode',
  };

  scene.variable = `scene_${scene.index}`;
  scene.className = 'Scene';
  scene.backgroundType = backgrounds[scene.background];
  scene.layers.forEach((layer, lidx) => {
    layer.className = layerClasses[layer.type];
    layer.variable = `${scene.variable}_layer_${lidx}`;
    layer.nodes.forEach((node, nidx) => {
      node.variable = `${layer.variable}_node_${nidx}`;
      node.className = nodeClasses[node.type];
    });
  });

  scene.nodes = scene.layers.reduce((arr, layer) => {
    layer.nodes.reduce((arr, node) => {
      arr.push(node);
      return arr;
    }, arr);
    return arr;
  }, []);
%>

  // Scene

  const uint8_t _<%= scene.variable %>[] PROGMEM = {
    <%= scene.backgroundType %>, // background: <%= scene.background %>
    <%= scene.size.width %>, // width
    <%= scene.size.height %> // height
  };
  const size_t _<%= scene.variable %>_size = sizeof(<%= scene.className %>);

  // Layers
  <% scene.layers.forEach((layer, idx) => { %>
  const uint8_t _<%= scene.variable %>_layer_<%= idx %>[] PROGMEM = {
  <% if(layer.type === 'grid') { %>
    0, // grid
    <%= layer.grid.width %>, // width
    <%= layer.grid.height -%> // height
  <% } else if(layer.type === 'pixel') { %>
    1 // pixel
  <% } %>
  };
  const size_t _<%= layer.variable %>_size = sizeof(<%= layer.className %>);
  <% }); %>
  const size_t _<%= scene.variable %>_layers_size = <%= scene.layers.map(layer => `_${layer.variable}_size` ).join(' + ')%>;

  // Nodes
  <% scene.layers.forEach((layer, lidx) => { -%>
  <% layer.nodes.forEach((node, nidx) => { %>
  // Node: <%= layer.identifier || lidx %> â†’ <%= node.identifier || nidx %>
  const uint8_t _<%= node.variable %>[] PROGMEM = {
  <% if(node.type === 'sprite/frame') { %>
    0, // type: <%= node.type %>
    <%= node.position.x %>, // position.x
    <%= node.position.y %>, // position.y
    <%= node.sprite.model.sprites.indexOf(node.sprite) %>, // sprite index
    <%= node.sprite.frames.indexOf(node.frame) -%> // frame index
  <% } else if(node.type === 'sprite/loop') { %>
    1, // type: <%= node.type %>
    <%= node.position.x %>, // position.x
    <%= node.position.y %>, // position.y
    <%= node.sprite.model.sprites.indexOf(node.sprite) %>, // sprite index
    <%= node.sprite.loops.indexOf(node.loop) -%> // loop index
  <% } %>
  };
  const size_t _<%= node.variable %>_size = sizeof(<%= node.className %>);
  <% }); %>
  const uint8_t * const _<%= layer.variable %>_nodes[] PROGMEM = { <%= layer.nodes.map(node => `_${node.variable}`).join(', ') %> };
  const size_t _<%= layer.variable %>_nodes_size = <%= layer.nodes.map(node => `_${node.variable}_size` ).join(' + ') %>;
  <% }); %>
  const size_t _<%= scene.variable %>_nodes_size = <%= scene.nodes.map(node => `_${node.variable}_size`).join(' + ') %>;
