<%
  let backgrounds = {
    'transparent': 0,
    'black': 1,
    'white': 2
  };

  let layerClasses = {
    'grid': 'GridLayer',
    'pixel': 'PixelLayer'
  };

  let nodeClasses = {
    'sprite/loop': 'SpriteLoopNode',
    'sprite/frame': 'SpriteFrameNode',
  };

  scene.className = 'Scene';
  scene.namespace = `Scene_${scene.index}`;
  scene.backgroundType = backgrounds[scene.background];
  scene.size = [];
  scene.layers.forEach((layer, lidx) => {
    layer.className = layerClasses[layer.type];
    layer.variable = `layer_${lidx}`;
    layer.nodes.forEach((node, nidx) => {
      node.variable = `${layer.variable}_node_${nidx}`;
      node.className = nodeClasses[node.type];
    });
  });

  scene.nodes = scene.layers.reduce((arr, layer) => {
    layer.nodes.reduce((arr, node) => {
      arr.push(node);
      return arr;
    }, arr);
    return arr;
  }, []);
-%>

  // Scene:  <%= scene.identifier %>
  namespace <%= scene.namespace %> {

    const uint8_t scene[] PROGMEM = {
      1
    };

    <% scene.size.push(`sizeof(${scene.className})`); %>

    <% scene.layers.forEach(layer => { %>

      const uint8_t <%= layer.variable %>[] PROGMEM = {
        1
      };

      <% scene.size.push(`sizeof(${layer.className})`); %>

      <% layer.nodes.forEach(node => { %>

        const uint8_t <%= node.variable %>[] PROGMEM = {
          1
        };

        const size_t <%= node.variable %>_size = sizeof(<%= node.className %>);

        <% scene.size.push(`sizeof(${node.className})`); %>

      <% }); %>

    <% }); %>

    const size_t scene_size = <%= scene.size.join(' + ') %>;

  }
